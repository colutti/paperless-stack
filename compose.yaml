services:
  # ----------------------------------------------------------------------------------
  # PAPERLESS CORE
  # ----------------------------------------------------------------------------------
  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless-ngx
    restart: unless-stopped
    env_file:
      - ./paperless/.env
    depends_on:
      - postgres
      - redis
      - gotenberg
      - tika
    ports:
      - "8001:8000" # <-- SEU PEDIDO: Acessível na porta 8001 do host
    volumes:
      - ./paperless/data:/usr/src/paperless/data:Z
      - ./paperless/media:/usr/src/paperless/media:Z
      - ./paperless/export:/usr/src/paperless/export:Z
      - ./paperless/consume:/usr/src/paperless/consume:Z
    dns:
      - 8.8.8.8
      - 1.1.1.1

  postgres:
    image: postgres:16
    restart: unless-stopped
    container_name: postgres
    env_file:
      - ./postgres/.env
    volumes:
      - ./postgres/data:/var/lib/postgresql/data:Z

  redis:
    image: docker.io/library/redis:7
    container_name: redis
    restart: unless-stopped
    env_file:
      - ./redis/.env
    volumes:
      - ./redis/data:/data:Z

  gotenberg:
    image: docker.io/gotenberg/gotenberg:8
    container_name: gotenberg
    env_file:
      - ./gotenberg/.env
    restart: unless-stopped
    command:
      - "gotenberg"
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"
    dns:
      - 8.8.8.8

  tika:
    image: docker.io/apache/tika:latest
    container_name: tika
    restart: unless-stopped
    env_file: ./tika/.env

  # ----------------------------------------------------------------------------------
  # AI & LLM STACK (AMD + PODMAN)
  # ----------------------------------------------------------------------------------
  open-webui:
    image: ghcr.io/open-webui/open-webui:latest
    container_name: open-webui
    restart: unless-stopped
    env_file:
      - ./open-webui/.env
    depends_on:
      - ollama
    ports:
      - "3001:8080"
    volumes:
      - ./open-webui/data:/app/backend/data:Z
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    dns:
      - 8.8.8.8
      - 1.1.1.1

  ollama:
    image: ollama/ollama:rocm # <-- VERSÃO AMD
    container_name: ollama
    env_file:
      - ./ollama/.env
    volumes:
      - ./ollama/data/:/root/.ollama:Z
      - ./ollama/models:/ollama-models:Z
    restart: unless-stopped
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    security_opt:
      - label=disable
    group_add:
      - video
    environment:
      - HSA_OVERRIDE_GFX_VERSION=11.0.0
      - OLLAMA_KEEP_ALIVE=5m
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_FLASH_ATTENTION=1
    dns:
      - 8.8.8.8
      - 1.1.1.1

  # ----------------------------------------------------------------------------------
  # PAPERLESS EXTENSIONS
  # ----------------------------------------------------------------------------------
  paperless-ai:
    image: clusterzx/paperless-ai:latest
    container_name: paperless-ai
    restart: unless-stopped
    depends_on:
      - ollama
      - paperless
    ports:
      - "3005:3000"
    env_file:
      - ./paperless-ai/.env
    volumes:
      - ./paperless-ai/data:/app/data:Z
    environment:
      - OLLAMA_API_URL=http://ollama:11434
    dns:
      - 8.8.8.8

  paperless-gpt:
    image: icereed/paperless-gpt:latest
    container_name: paperless-gpt
    restart: unless-stopped
    depends_on:
      - ollama
      - paperless
    ports:
      - "3002:8080"
    env_file:
      - ./paperless-gpt/.env
    volumes:
      - ./paperless-gpt/prompts:/app/prompts:Z
    dns:
      - 8.8.8.8

  # ----------------------------------------------------------------------------------
  # MONITORING
  # ----------------------------------------------------------------------------------
  dozzle:
    image: amir20/dozzle:latest
    restart: unless-stopped
    container_name: dozzle
    env_file:
      - ./dozzle/.env
    volumes:
      # Ajustado para Podman rootless (UID 1000)
      - /run/user/1000/podman/podman.sock:/var/run/docker.sock:Z
      - ./dozzle/data:/data:Z
    ports:
      - "4000:8080"
    security_opt:
      - label=disable
